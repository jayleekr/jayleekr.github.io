<!--
  Analytics Dashboard Integration
  Real-time analytics monitoring and experiment tracking
  v1.0 - Created 2025-08-04
-->

<script>
(function() {
  'use strict';
  
  // Analytics Dashboard Manager
  window.AnalyticsDashboard = {
    
    // Dashboard configuration
    config: {
      refresh_interval: 30000, // 30 seconds
      metrics_retention: 24 * 60 * 60 * 1000, // 24 hours in localStorage
      max_stored_metrics: 1000,
      debug_mode: false
    },
    
    // Metrics store
    metricsStore: {
      page_views: [],
      user_interactions: [],
      performance_metrics: [],
      experiment_data: [],
      error_logs: []
    },
    
    // Initialize dashboard
    init: function() {
      if (!this.hasAnalyticsConsent()) {
        console.log('Analytics Dashboard disabled - no user consent');
        return;
      }
      
      this.loadStoredMetrics();
      this.setupMetricsCollection();
      this.setupRealTimeTracking();
      
      // Add dashboard toggle for developers
      if (this.config.debug_mode || window.location.search.includes('analytics=debug')) {
        this.createDebugInterface();
      }
      
      console.log('Analytics Dashboard initialized');
    },
    
    // Check analytics consent
    hasAnalyticsConsent: function() {
      return window.hasAnalyticsConsent || window.hasPerformanceConsent || false;
    },
    
    // Load metrics from localStorage
    loadStoredMetrics: function() {
      try {\n        const stored = localStorage.getItem('analytics_dashboard_metrics');\n        if (stored) {\n          const data = JSON.parse(stored);\n          \n          // Clean old data\n          const now = Date.now();\n          const retention = this.config.metrics_retention;\n          \n          Object.keys(data).forEach(key => {\n            if (Array.isArray(data[key])) {\n              data[key] = data[key].filter(item => {\n                return (now - item.timestamp) < retention;\n              });\n            }\n          });\n          \n          this.metricsStore = { ...this.metricsStore, ...data };\n        }\n      } catch (e) {\n        console.warn('Failed to load stored metrics:', e);\n      }\n    },\n    \n    // Save metrics to localStorage\n    saveMetrics: function() {\n      try {\n        // Limit storage size\n        const limitedStore = {};\n        Object.keys(this.metricsStore).forEach(key => {\n          if (Array.isArray(this.metricsStore[key])) {\n            limitedStore[key] = this.metricsStore[key].slice(-this.config.max_stored_metrics);\n          } else {\n            limitedStore[key] = this.metricsStore[key];\n          }\n        });\n        \n        localStorage.setItem('analytics_dashboard_metrics', JSON.stringify(limitedStore));\n      } catch (e) {\n        console.warn('Failed to save metrics:', e);\n      }\n    },\n    \n    // Setup metrics collection\n    setupMetricsCollection: function() {\n      // Collect page view data\n      this.collectPageView();\n      \n      // Listen for custom events\n      document.addEventListener('analytics-event', (e) => {\n        this.recordEvent(e.detail);\n      });\n      \n      // Monitor performance metrics\n      if (window.PerformanceAnalytics) {\n        this.monitorPerformanceMetrics();\n      }\n      \n      // Monitor experiment assignments\n      if (window.ABTesting && window.ABTesting.activeExperiments) {\n        this.recordExperimentData();\n      }\n    },\n    \n    // Collect page view information\n    collectPageView: function() {\n      const pageView = {\n        url: window.location.href,\n        title: document.title,\n        referrer: document.referrer,\n        user_agent: navigator.userAgent,\n        viewport: `${window.innerWidth}x${window.innerHeight}`,\n        timestamp: Date.now(),\n        session_id: this.getSessionId()\n      };\n      \n      this.metricsStore.page_views.push(pageView);\n      this.saveMetrics();\n    },\n    \n    // Record user interaction event\n    recordEvent: function(eventData) {\n      const event = {\n        ...eventData,\n        timestamp: Date.now(),\n        session_id: this.getSessionId(),\n        page_url: window.location.href\n      };\n      \n      this.metricsStore.user_interactions.push(event);\n      this.saveMetrics();\n    },\n    \n    // Monitor performance metrics\n    monitorPerformanceMetrics: function() {\n      const self = this;\n      \n      // Override PerformanceAnalytics reportMetric to capture data\n      const originalReportMetric = window.PerformanceAnalytics.reportMetric;\n      \n      window.PerformanceAnalytics.reportMetric = function(metricName, metricData) {\n        // Call original method\n        originalReportMetric.call(this, metricName, metricData);\n        \n        // Store in dashboard\n        self.metricsStore.performance_metrics.push({\n          metric_name: metricName,\n          metric_data: metricData,\n          timestamp: Date.now(),\n          session_id: self.getSessionId()\n        });\n        \n        self.saveMetrics();\n      };\n    },\n    \n    // Record experiment data\n    recordExperimentData: function() {\n      const experiments = window.ABTesting.activeExperiments;\n      \n      Object.keys(experiments).forEach(experimentKey => {\n        const experiment = experiments[experimentKey];\n        \n        this.metricsStore.experiment_data.push({\n          experiment_id: experiment.id,\n          experiment_name: experiment.name,\n          variant: experiment.variant,\n          variant_name: experiment.variantName,\n          timestamp: Date.now(),\n          session_id: this.getSessionId(),\n          page_url: window.location.href\n        });\n      });\n      \n      this.saveMetrics();\n    },\n    \n    // Setup real-time tracking\n    setupRealTimeTracking: function() {\n      // Track scroll depth\n      let maxScrollDepth = 0;\n      const trackScrollDepth = () => {\n        const scrollPercent = Math.round(\n          (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100\n        );\n        \n        if (scrollPercent > maxScrollDepth) {\n          maxScrollDepth = scrollPercent;\n          \n          // Dispatch custom event\n          document.dispatchEvent(new CustomEvent('analytics-event', {\n            detail: {\n              event_type: 'scroll_depth',\n              scroll_percent: scrollPercent,\n              max_scroll_depth: maxScrollDepth\n            }\n          }));\n        }\n      };\n      \n      let scrollTimer;\n      window.addEventListener('scroll', () => {\n        if (scrollTimer) clearTimeout(scrollTimer);\n        scrollTimer = setTimeout(trackScrollDepth, 100);\n      });\n      \n      // Track time on page\n      const startTime = Date.now();\n      let lastActivityTime = startTime;\n      \n      // Update activity time on user interactions\n      ['click', 'scroll', 'keypress', 'mousemove'].forEach(eventType => {\n        document.addEventListener(eventType, () => {\n          lastActivityTime = Date.now();\n        });\n      });\n      \n      // Report time on page when leaving\n      window.addEventListener('beforeunload', () => {\n        const timeOnPage = Date.now() - startTime;\n        const activeTime = lastActivityTime - startTime;\n        \n        document.dispatchEvent(new CustomEvent('analytics-event', {\n          detail: {\n            event_type: 'time_on_page',\n            total_time: timeOnPage,\n            active_time: activeTime,\n            scroll_depth: maxScrollDepth\n          }\n        }));\n      });\n    },\n    \n    // Get or create session ID\n    getSessionId: function() {\n      let sessionId = sessionStorage.getItem('analytics_session_id');\n      \n      if (!sessionId) {\n        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n        sessionStorage.setItem('analytics_session_id', sessionId);\n      }\n      \n      return sessionId;\n    },\n    \n    // Create debug interface\n    createDebugInterface: function() {\n      const debugPanel = document.createElement('div');\n      debugPanel.id = 'analytics-debug-panel';\n      debugPanel.innerHTML = `\n        <div class=\"debug-header\">\n          <h4>ðŸ“Š Analytics Debug</h4>\n          <button id=\"debug-toggle\">Toggle</button>\n        </div>\n        <div class=\"debug-content\" style=\"display: none;\">\n          <div class=\"debug-section\">\n            <h5>Session Info</h5>\n            <div id=\"session-info\"></div>\n          </div>\n          <div class=\"debug-section\">\n            <h5>Active Experiments</h5>\n            <div id=\"experiments-info\"></div>\n          </div>\n          <div class=\"debug-section\">\n            <h5>Performance Metrics</h5>\n            <div id=\"performance-info\"></div>\n          </div>\n          <div class=\"debug-section\">\n            <h5>Recent Events</h5>\n            <div id=\"events-info\"></div>\n          </div>\n          <div class=\"debug-actions\">\n            <button id=\"export-data\">Export Data</button>\n            <button id=\"clear-data\">Clear Data</button>\n          </div>\n        </div>\n      `;\n      \n      // Add styles\n      const debugStyles = document.createElement('style');\n      debugStyles.textContent = `\n        #analytics-debug-panel {\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          width: 300px;\n          background: #fff;\n          border: 1px solid #ccc;\n          border-radius: 8px;\n          box-shadow: 0 4px 12px rgba(0,0,0,0.1);\n          z-index: 10000;\n          font-family: monospace;\n          font-size: 12px;\n        }\n        \n        .debug-header {\n          padding: 10px;\n          background: #f8f9fa;\n          border-bottom: 1px solid #dee2e6;\n          border-radius: 8px 8px 0 0;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n        }\n        \n        .debug-header h4 {\n          margin: 0;\n          font-size: 14px;\n        }\n        \n        .debug-content {\n          max-height: 400px;\n          overflow-y: auto;\n          padding: 10px;\n        }\n        \n        .debug-section {\n          margin-bottom: 15px;\n        }\n        \n        .debug-section h5 {\n          margin: 0 0 5px 0;\n          font-size: 12px;\n          color: #666;\n        }\n        \n        .debug-actions {\n          display: flex;\n          gap: 5px;\n          margin-top: 10px;\n        }\n        \n        .debug-actions button {\n          flex: 1;\n          padding: 5px;\n          font-size: 11px;\n          border: 1px solid #ccc;\n          background: #f8f9fa;\n          border-radius: 4px;\n          cursor: pointer;\n        }\n        \n        @media (max-width: 768px) {\n          #analytics-debug-panel {\n            width: 250px;\n            top: 10px;\n            right: 10px;\n          }\n        }\n      `;\n      \n      document.head.appendChild(debugStyles);\n      document.body.appendChild(debugPanel);\n      \n      // Bind events\n      this.bindDebugEvents();\n      this.updateDebugInfo();\n      \n      // Auto-update debug info\n      setInterval(() => {\n        this.updateDebugInfo();\n      }, this.config.refresh_interval);\n    },\n    \n    // Bind debug panel events\n    bindDebugEvents: function() {\n      document.getElementById('debug-toggle').addEventListener('click', () => {\n        const content = document.querySelector('.debug-content');\n        content.style.display = content.style.display === 'none' ? 'block' : 'none';\n      });\n      \n      document.getElementById('export-data').addEventListener('click', () => {\n        this.exportAnalyticsData();\n      });\n      \n      document.getElementById('clear-data').addEventListener('click', () => {\n        if (confirm('Clear all stored analytics data?')) {\n          localStorage.removeItem('analytics_dashboard_metrics');\n          this.metricsStore = {\n            page_views: [],\n            user_interactions: [],\n            performance_metrics: [],\n            experiment_data: [],\n            error_logs: []\n          };\n          this.updateDebugInfo();\n        }\n      });\n    },\n    \n    // Update debug information\n    updateDebugInfo: function() {\n      // Session info\n      document.getElementById('session-info').innerHTML = `\n        Session: ${this.getSessionId().slice(-8)}<br>\n        Page Views: ${this.metricsStore.page_views.length}<br>\n        Events: ${this.metricsStore.user_interactions.length}\n      `;\n      \n      // Experiments info\n      const experimentsInfo = window.ABTesting && window.ABTesting.activeExperiments ? \n        Object.keys(window.ABTesting.activeExperiments).map(key => {\n          const exp = window.ABTesting.activeExperiments[key];\n          return `${exp.name}: ${exp.variant}`;\n        }).join('<br>') : 'None active';\n      \n      document.getElementById('experiments-info').innerHTML = experimentsInfo;\n      \n      // Performance info\n      const perfMetrics = this.metricsStore.performance_metrics.slice(-3);\n      const perfInfo = perfMetrics.map(metric => \n        `${metric.metric_name}: ${JSON.stringify(metric.metric_data.value || 'N/A')}`\n      ).join('<br>') || 'No data';\n      \n      document.getElementById('performance-info').innerHTML = perfInfo;\n      \n      // Recent events\n      const recentEvents = this.metricsStore.user_interactions.slice(-5);\n      const eventsInfo = recentEvents.map(event => \n        `${event.event_type}: ${new Date(event.timestamp).toLocaleTimeString()}`\n      ).join('<br>') || 'No events';\n      \n      document.getElementById('events-info').innerHTML = eventsInfo;\n    },\n    \n    // Export analytics data\n    exportAnalyticsData: function() {\n      const data = {\n        export_timestamp: new Date().toISOString(),\n        session_id: this.getSessionId(),\n        metrics_store: this.metricsStore,\n        config: this.config\n      };\n      \n      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      \n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `analytics-data-${new Date().toISOString().slice(0, 10)}.json`;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      \n      URL.revokeObjectURL(url);\n    },\n    \n    // Get analytics summary\n    getAnalyticsSummary: function() {\n      const summary = {\n        session_id: this.getSessionId(),\n        total_page_views: this.metricsStore.page_views.length,\n        total_interactions: this.metricsStore.user_interactions.length,\n        performance_metrics_count: this.metricsStore.performance_metrics.length,\n        active_experiments: window.ABTesting && window.ABTesting.activeExperiments ? \n          Object.keys(window.ABTesting.activeExperiments).length : 0,\n        last_updated: new Date().toISOString()\n      };\n      \n      return summary;\n    }\n  };\n  \n  // Initialize when DOM is ready\n  document.addEventListener('DOMContentLoaded', function() {\n    // Wait for other analytics components\n    setTimeout(() => {\n      window.AnalyticsDashboard.init();\n    }, 2000);\n  });\n  \n})();\n</script>"